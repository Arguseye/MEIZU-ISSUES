jQuery(function($) {
  var fileFieldCount = 1;
  var attachFieldCount = 1;   
  Dropzone.options.dropzone = {
    dictDefaultMessage: "添加文件(支持拖拽)",
    url: "/projects/<%= @issue.project.id %>/files/upload",
    maxFilesize: <%= Setting.attachment_max_size.to_i / 1024 %>, // MB
    maxThumbnailFilesize: 5 ,
  
    init: function() {
       this.on("processingfile", function(file) {
         this.options.paramName = "attachments[" + attachFieldCount + "][file]";
         attachFieldCount ++ ;       
       });
    
       this.on("addedfile", function(file) {     
         $('#button_submit').attr('disabled', true);
         var _this = this;          
         $(file.previewTemplate.querySelector(".error-mark")).on('click', function() {
            _this.removeFile(file); 
         });
       });  
          
       this.on("removedfile", function(file) { 
         var attachment_token = $(file.previewTemplate.querySelector('.details .fileid')).val();
         $.ajax({
           url: "/attachments/" + attachment_token,
           dataType: "script",
           type: "DELETE"
         })
       });     
     
       this.on("finished", function(file, responseText, e) {       file.previewTemplate.querySelector(".details").appendChild(Dropzone.createElement("<input  class=\"fileid\" type=\"hidden\"  name=\"attachments[" + fileFieldCount + "][token]\" value=\"" + responseText.attachment_token + "\" >"))
         fileFieldCount ++ ;               
       });
     
       this.on("complete", function() {
         if (this.filesQueue.length == 0 && this.filesProcessing.length == 0) {
           $('#button_submit').attr('disabled', false);
         }
       });
     
     }
  };
})  